import{m as g,C as d,h as f,T as x,d as C,M as y,a as k}from"./index.8a9f494f.js";function p(s){let t=new DOMParser().parseFromString(s,"text/html");return t.querySelectorAll('a[href*="://"]').forEach(a=>{a.setAttribute("target","_blank")}),t.documentElement.outerHTML}window.Alpine=g;g.store("challenge",{data:{view:""}});g.data("Hint",()=>({id:null,html:null,async showHint(s){if(s.target.open){let t=(await d.pages.challenge.loadHint(this.id)).data;if(t.content)this.html=p(t.html);else if(await d.pages.challenge.displayUnlock(this.id)){let a=await d.pages.challenge.loadUnlock(this.id);if(a.success){let n=(await d.pages.challenge.loadHint(this.id)).data;this.html=p(n.html)}else s.target.open=!1,d._functions.challenge.displayUnlockError(a)}else s.target.open=!1}}}));g.data("Challenge",()=>({id:null,next_id:null,submission:"",tab:null,solves:[],response:null,share_url:null,max_attempts:0,attempts:0,async init(){f()},getStyles(){let s={"modal-dialog":!0};try{switch(d.config.themeSettings.challenge_window_size){case"sm":s["modal-sm"]=!0;break;case"lg":s["modal-lg"]=!0;break;case"xl":s["modal-xl"]=!0;break;default:break}}catch(e){console.log("Error processing challenge_window_size"),console.log(e)}return s},async init(){f()},async showChallenge(){new x(this.$el).show()},async showSolves(){this.solves=await d.pages.challenge.loadSolves(this.id),this.solves.forEach(s=>(s.date=C(s.date).format("MMMM Do, h:mm:ss A"),s)),new x(this.$el).show()},getNextId(){return g.store("challenge").data.next_id},async nextChallenge(){let s=y.getOrCreateInstance("[x-ref='challengeWindow']");s._element.addEventListener("hidden.bs.modal",e=>{g.nextTick(()=>{this.$dispatch("load-challenge",this.getNextId())})},{once:!0}),s.hide()},async getShareUrl(){let s={type:"solve",challenge_id:this.id};const l=(await(await d.fetch("/api/v1/shares",{method:"POST",body:JSON.stringify(s)})).json()).data.url;this.share_url=l},copyShareUrl(){navigator.clipboard.writeText(this.share_url);let s=k.getOrCreateInstance(this.$el);s.enable(),s.show(),setTimeout(()=>{s.hide(),s.disable()},2e3)},async submitChallenge(){this.response=await d.pages.challenge.submitChallenge(this.id,this.submission),await this.renderSubmissionResponse()},async renderSubmissionResponse(){this.response.data.status==="correct"&&(this.submission=""),this.max_attempts>0&&this.response.data.status!="already_solved"&&(this.attempts+=1),this.$dispatch("load-challenges")}}));g.data("ChallengeBoard",()=>({loaded:!1,challenges:[],challenge:null,async init(){if(this.challenges=await d.pages.challenges.getChallenges(),window.mapManager=new v(this.challenges),this.loaded=!0,window.location.hash){let s=decodeURIComponent(window.location.hash.substring(1)),e=s.lastIndexOf("-");if(e>=0){let l=[s.slice(0,e),s.slice(e+1)][1];await this.loadChallenge(l)}}},getCategories(){const s=[];this.challenges.forEach(e=>{const{category:t}=e;s.includes(t)||s.push(t)});try{const e=d.config.themeSettings.challenge_category_order;if(e){const t=new Function(`return (${e})`);s.sort(t())}}catch(e){console.log("Error running challenge_category_order function"),console.log(e)}return s},getChallenges(s){let e=this.challenges;s!==null&&(e=this.challenges.filter(t=>t.category===s));try{const t=d.config.themeSettings.challenge_order;if(t){const l=new Function(`return (${t})`);e.sort(l())}}catch(t){console.log("Error running challenge_order function"),console.log(t)}return e},async loadChallenges(){this.challenges=await d.pages.challenges.getChallenges(),window.mapManager=new v(this.challenges)},async loadChallenge(s){await d.pages.challenge.displayChallenge(s,e=>{e.data.view=p(e.data.view),g.store("challenge").data=e.data,g.nextTick(()=>{let t=y.getOrCreateInstance("[x-ref='challengeWindow']");t._element.addEventListener("hidden.bs.modal",l=>{history.replaceState(null,null," ")},{once:!0}),t.show(),history.replaceState(null,null,`#${e.data.name}-${s}`)})})}}));g.start();class v{constructor(e){this.challenges=e,this.icons=[],this.registerMouseOverHook(),this.width=1020,this.height=496,this.render()}getChallenges(){return this.challenges}async render(){await this.renderBackground(),await this.renderRoomText(),await this.renderTasks()}async renderBackground(){const e=document.getElementById("map"),t=e.getContext("2d"),l=new Image;l.src="/themes/atr25-theme/static/img/map.svg",await new Promise(a=>{l.onload=()=>{t.drawImage(l,0,0,e.width,e.height),a()}})}async renderRoomText(){let t=[{text:"Main Hall",x:764,y:404,room:"202"},{text:"Reception",x:350,y:380,room:"202.2"},{text:"Deepwell|Archive",x:90,y:363,room:"203"},{text:"Cafeteria",x:150,y:100,room:"204"},{text:"Terrestrial|History",x:363,y:100,room:"205"},{text:"Astral|Sciences",x:560,y:100,room:"206"},{text:"Staff Halls",x:753,y:100,room:"207"},{text:"The Lion's|Eye|Diamond",x:944,y:100,room:"208"}];window.serverTexts&&(t=window.serverTexts);const a=document.getElementById("map").getContext("2d");a.font="26px Arial",a.textAlign="center",a.textBaseline="middle",a.strokeStyle="black",a.lineWidth=4,a.fillStyle="white";for(let o=0;o<t.length;o++){const n=t[o],i=n.text.split("|"),h=36,r=n.y-(i.length-1)*(h/2);for(let c=0;c<i.length;c++){const u=r+c*h;a.strokeText(i[c],n.x,u),a.fillText(i[c],n.x,u)}}}async renderTasks(){let e=this.challenges.filter(t=>t.tags&&t.tags.length>0&&!t.solved_by_me);for(let t=0;t<e.length;t++){const l=e[t],a={};for(let i=0;i<l.tags.length;i++){const h=l.tags[i].value.split(":"),r=h[0],c=h[1];r&&c&&(a[r]=c)}const n=document.getElementById("map").getContext("2d");if(a.x&&a.y){const i=parseInt(a.x),h=parseInt(a.y),r=new Image;r.src="/themes/atr25-theme/static/img/task.png",r.onload=()=>{n.drawImage(r,i,h,49,49),this.icons.push({x:i,y:h,width:49,height:49,task:l})}}}}registerMouseOverHook(){const e=document.getElementById("map");let t=null;e.addEventListener("mousemove",l=>{const a=e.getBoundingClientRect(),o=l.clientX-a.left,n=l.clientY-a.top,i=a.width/this.width,h=a.height/this.height,r=o/i,c=n/h;let u=!1;for(let w=0;w<this.icons.length;w++){const m=this.icons[w];if(r>=m.x&&r<=m.x+m.width&&c>=m.y&&c<=m.y+m.height){u=!0,t=m.task;const b=window.scrollX||document.documentElement.scrollLeft,T=window.scrollY||document.documentElement.scrollTop;this.showTooltip(m.task,l.clientX+b,l.clientY+T),e.style.cursor="pointer";break}}u||(t=null,e.style.cursor="default",this.hideTooltip())}),e.addEventListener("click",async()=>{if(t){const l=t.id;l&&(this.hideTooltip(),await d.pages.challenge.displayChallenge(l,a=>{a.data.view=p(a.data.view),g.store("challenge").data=a.data,g.nextTick(()=>{let o=y.getOrCreateInstance("[x-ref='challengeWindow']");o._element.addEventListener("hidden.bs.modal",()=>{history.replaceState(null,null,"/challenges")},{once:!0}),o.show(),history.replaceState(null,null,`#${a.data.name}-${l}`)})}))}})}showTooltip(e,t,l){let a=document.getElementById("map-tooltip");a||(a=document.createElement("div"),a.id="map-tooltip",document.body.appendChild(a));let o=e.category;if(e.tags){for(let c=0;c<e.tags.length;c++)if(e.tags[c].value==="c:0"){o="";break}}let n=document.createElement("div");n.style.position="absolute",n.style.visibility="hidden",n.style.whiteSpace="nowrap",n.innerHTML=`
      <div>${e.name}</div>
      <div>${o!=""?o+" - ":""}${e.value}</div>
    `,document.body.appendChild(n);const i=n.offsetWidth;document.body.removeChild(n);const h=window.innerWidth;let r=t+10;r+i>h&&(r=t-i-10),a.innerHTML=`
      <div>${e.name}</div>
      <div>${o!=""?o+" - ":""}${e.value}</div>
    `,a.style.left=`${r}px`,a.style.top=`${l+10}px`,a.classList.add("visible")}hideTooltip(){const e=document.getElementById("map-tooltip");e&&e.classList.remove("visible")}}
