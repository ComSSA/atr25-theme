import{m as i,C as n,h as x,T as f,d as v,M as w,a as T}from"./index.8a9f494f.js";function p(a){let s=new DOMParser().parseFromString(a,"text/html");return s.querySelectorAll('a[href*="://"]').forEach(t=>{t.setAttribute("target","_blank")}),s.documentElement.outerHTML}window.Alpine=i;i.store("challenge",{data:{view:""}});i.data("Hint",()=>({id:null,html:null,async showHint(a){if(a.target.open){let s=(await n.pages.challenge.loadHint(this.id)).data;if(s.content)this.html=p(s.html);else if(await n.pages.challenge.displayUnlock(this.id)){let t=await n.pages.challenge.loadUnlock(this.id);if(t.success){let d=(await n.pages.challenge.loadHint(this.id)).data;this.html=p(d.html)}else a.target.open=!1,n._functions.challenge.displayUnlockError(t)}else a.target.open=!1}}}));i.data("Challenge",()=>({id:null,next_id:null,submission:"",tab:null,solves:[],response:null,share_url:null,max_attempts:0,attempts:0,async init(){x()},getStyles(){let a={"modal-dialog":!0};try{switch(n.config.themeSettings.challenge_window_size){case"sm":a["modal-sm"]=!0;break;case"lg":a["modal-lg"]=!0;break;case"xl":a["modal-xl"]=!0;break;default:break}}catch(e){console.log("Error processing challenge_window_size"),console.log(e)}return a},async init(){x()},async showChallenge(){new f(this.$el).show()},async showSolves(){this.solves=await n.pages.challenge.loadSolves(this.id),this.solves.forEach(a=>(a.date=v(a.date).format("MMMM Do, h:mm:ss A"),a)),new f(this.$el).show()},getNextId(){return i.store("challenge").data.next_id},async nextChallenge(){let a=w.getOrCreateInstance("[x-ref='challengeWindow']");a._element.addEventListener("hidden.bs.modal",e=>{i.nextTick(()=>{this.$dispatch("load-challenge",this.getNextId())})},{once:!0}),a.hide()},async getShareUrl(){let a={type:"solve",challenge_id:this.id};const l=(await(await n.fetch("/api/v1/shares",{method:"POST",body:JSON.stringify(a)})).json()).data.url;this.share_url=l},copyShareUrl(){navigator.clipboard.writeText(this.share_url);let a=T.getOrCreateInstance(this.$el);a.enable(),a.show(),setTimeout(()=>{a.hide(),a.disable()},2e3)},async submitChallenge(){this.response=await n.pages.challenge.submitChallenge(this.id,this.submission),await this.renderSubmissionResponse()},async renderSubmissionResponse(){this.response.data.status==="correct"&&(this.submission=""),this.max_attempts>0&&this.response.data.status!="already_solved"&&(this.attempts+=1),this.$dispatch("load-challenges")}}));i.data("ChallengeBoard",()=>({loaded:!1,challenges:[],challenge:null,async init(){if(this.challenges=await n.pages.challenges.getChallenges(),window.mapManager=new C(this.challenges),this.loaded=!0,window.location.hash){let a=decodeURIComponent(window.location.hash.substring(1)),e=a.lastIndexOf("-");if(e>=0){let l=[a.slice(0,e),a.slice(e+1)][1];await this.loadChallenge(l)}}},getCategories(){const a=[];this.challenges.forEach(e=>{const{category:s}=e;a.includes(s)||a.push(s)});try{const e=n.config.themeSettings.challenge_category_order;if(e){const s=new Function(`return (${e})`);a.sort(s())}}catch(e){console.log("Error running challenge_category_order function"),console.log(e)}return a},getChallenges(a){let e=this.challenges;a!==null&&(e=this.challenges.filter(s=>s.category===a));try{const s=n.config.themeSettings.challenge_order;if(s){const l=new Function(`return (${s})`);e.sort(l())}}catch(s){console.log("Error running challenge_order function"),console.log(s)}return e},async loadChallenges(){this.challenges=await n.pages.challenges.getChallenges()},async loadChallenge(a){await n.pages.challenge.displayChallenge(a,e=>{e.data.view=p(e.data.view),i.store("challenge").data=e.data,i.nextTick(()=>{let s=w.getOrCreateInstance("[x-ref='challengeWindow']");s._element.addEventListener("hidden.bs.modal",l=>{history.replaceState(null,null," ")},{once:!0}),s.show(),history.replaceState(null,null,`#${e.data.name}-${a}`)})})}}));i.start();class C{constructor(e){this.challenges=e,this.icons=[],this.registerMouseOverHook(),this.width=1020,this.height=496,this.render()}getChallenges(){return this.challenges}async render(){await this.renderBackground(),await this.renderRoomText(),await this.renderTasks()}async renderBackground(){const e=document.getElementById("map"),s=e.getContext("2d"),l=new Image;l.src="/themes/atr25-theme/static/img/map.svg",await new Promise(t=>{l.onload=()=>{s.drawImage(l,0,0,e.width,e.height),t()}})}async renderRoomText(){let s=[{text:"Something|Here",x:764,y:404,room:"202"},{text:"Something|Here",x:350,y:380,room:"202.2"},{text:"203",x:90,y:363,room:"203"},{text:"Cafeteria",x:150,y:100,room:"204"},{text:"Terrestrial|History",x:363,y:100,room:"205"},{text:"Astral|Sciences",x:560,y:100,room:"206"},{text:"Staff Halls",x:753,y:100,room:"207"},{text:"The Lion's|Eye|Diamond",x:944,y:100,room:"208"}];window.serverTexts&&(s=window.serverTexts);const t=document.getElementById("map").getContext("2d");t.font="26px Arial",t.textAlign="center",t.textBaseline="middle",t.strokeStyle="black",t.lineWidth=4,t.fillStyle="white";for(let h=0;h<s.length;h++){const d=s[h],o=d.text.split("|"),g=36,r=d.y-(o.length-1)*(g/2);for(let c=0;c<o.length;c++){const u=r+c*g;t.strokeText(o[c],d.x,u),t.fillText(o[c],d.x,u)}}}async renderTasks(){let e=this.challenges.filter(s=>s.tags&&s.tags.length>0);console.log(e);for(let s=0;s<e.length;s++){const l=e[s],t={};for(let o=0;o<l.tags.length;o++){const g=l.tags[o].value.split(":"),r=g[0],c=g[1];r&&c&&(t[r]=c)}const d=document.getElementById("map").getContext("2d");if(t.x&&t.y){const o=parseInt(t.x),g=parseInt(t.y),r=new Image;r.src="/themes/atr25-theme/static/img/task.png",r.onload=()=>{d.drawImage(r,o,g,49,49),this.icons.push({x:o,y:g,width:49,height:49,task:l})}}}}registerMouseOverHook(){const e=document.getElementById("map");let s=null;e.addEventListener("mousemove",l=>{const t=e.getBoundingClientRect(),h=l.clientX-t.left,d=l.clientY-t.top,o=t.width/this.width,g=t.height/this.height,r=h/o,c=d/g;let u=!1;for(let y=0;y<this.icons.length;y++){const m=this.icons[y];if(r>=m.x&&r<=m.x+m.width&&c>=m.y&&c<=m.y+m.height){u=!0,s=m.task;const k=window.scrollX||document.documentElement.scrollLeft,b=window.scrollY||document.documentElement.scrollTop;this.showTooltip(m.task,l.clientX+k,l.clientY+b),e.style.cursor="pointer";break}}u||(s=null,e.style.cursor="default",this.hideTooltip())}),e.addEventListener("click",async()=>{if(s){const l=s.id;l&&(this.hideTooltip(),await n.pages.challenge.displayChallenge(l,t=>{t.data.view=p(t.data.view),i.store("challenge").data=t.data,i.nextTick(()=>{let h=w.getOrCreateInstance("[x-ref='challengeWindow']");h._element.addEventListener("hidden.bs.modal",()=>{history.replaceState(null,null,"/challenges")},{once:!0}),h.show(),history.replaceState(null,null,`#${t.data.name}-${l}`)})}))}})}showTooltip(e,s,l){let t=document.getElementById("map-tooltip");t||(t=document.createElement("div"),t.id="map-tooltip",t.style.position="absolute",t.style.background="rgba(0, 0, 0, 0.8)",t.style.color="white",t.style.padding="5px",t.style.borderRadius="5px",t.style.pointerEvents="none",document.body.appendChild(t)),t.textContent=e.name||"Task",t.style.left=`${s+10}px`,t.style.top=`${l+10}px`,t.style.display="block"}hideTooltip(){const e=document.getElementById("map-tooltip");e&&(e.style.display="none")}}
